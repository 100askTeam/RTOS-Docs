var q=Object.defineProperty,N=Object.getOwnPropertySymbols,G=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,_=(r,t,e)=>t in r?q(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,x=(r,t)=>{for(var e in t||(t={}))G.call(t,e)&&_(r,e,t[e]);if(N)for(var e of N(t))J.call(t,e)&&_(r,e,t[e]);return r},a=(r,t,e)=>(_(r,typeof t!="symbol"?t+"":t,e),e),S=(r,t,e)=>new Promise((i,s)=>{var u=h=>{try{m(e.next(h))}catch(f){s(f)}},c=h=>{try{m(e.throw(h))}catch(f){s(f)}},m=h=>h.done?i(h.value):Promise.resolve(h.value).then(u,c);m((e=e.apply(r,t)).next())}),Q={gapX:100,gapY:100,offsetLeft:0,offsetTop:0,width:120,height:64,opacity:.15,rotate:-22,fontSize:16,fontStyle:"normal",fontVariant:"normal",fontWeight:"300",fontColor:"#000",fontFamily:"sans-serif",textAlign:"center",textBaseline:"alphabetic",monitor:!0,zIndex:9999,mode:"interval",pack:!0,blindFontSize:16,blindOpacity:.005},d="data-watermark-tag",T={childList:!0,subtree:!0,attributeFilter:["style","class",d]};function tt(){return window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver}function et(r){return r.split("-").slice(1).reduce((t,e,i)=>i===0?e:`${t}${e[0].toUpperCase()+e.slice(1)}`)}var g=r=>{let t="";return Object.keys(r).forEach(e=>{const i=e.replace(/([A-Z])/g,"-$1").toLowerCase();t+=`${i}:${r[e]};`}),t},rt=r=>window.btoa(decodeURI(encodeURIComponent(r))),it=(r="")=>`${rt(r)}-${new Date().getTime()}-${Math.floor(Math.random()*Math.pow(10,8))}`,ot=(r,t,e={},i)=>{let s;if(typeof r=="string"){if(s=document.getElementById(r),!s)throw new Error(`水印挂载节点未找到，请检查#${r}是否存在`)}else s=r??document.body;s.setAttribute(d,t);const u=x({position:"relative"},e);return i||delete u.position,s.setAttribute("style",g(u)),s},st=r=>{const t=r.getImageData(0,0,r.canvas.width,r.canvas.height);let e=t.data;for(let i=0;i<e.length;i++)if(i%4==0)e[i]%2==0?e[i]=0:e[i]=255;else{if(i%4==3)continue;e[i]=0}r.putImageData(t,0,0)},at=r=>{const t=document.createElement("div");return t.setAttribute("style",g({pointerEvents:"none"})),t.setAttribute(d,r),t};function nt(r){const{text:t,gapX:e,gapY:i,offsetTop:s,offsetLeft:u,width:c,height:m,rotate:h,opacity:f,fontSize:C,fontStyle:P,fontVariant:E,fontWeight:F,fontFamily:z,fontColor:W,textAlign:B,textBaseline:L,image:D,blindText:$,blindFontSize:H,blindOpacity:U}=r;return new Promise((A,j)=>{const v=document.createElement("canvas"),o=v.getContext("2d"),l=1,y=(Number(e)+Number(c))*l,k=(Number(i)+Number(m))*l,V=Number(u)||Number(e)/2,Y=Number(s)||Number(i)/2;if(v.setAttribute("width",`${y}px`),v.setAttribute("height",`${k}px`),o){const w=c*l,R=m*l;if(o.translate(V*l,Y*l),o.rotate(Math.PI/180*Number(h)),$&&(o.globalAlpha=U,o.font=`${H}px normal`,o.fillText($,0,0)),o.globalAlpha=f,D){const n=new Image;n.crossOrigin="anonymous",n.referrerPolicy="no-referrer",n.src=D,n.onload=()=>{o.drawImage(n,0,0,w,R),A({url:o.canvas.toDataURL(),width:y,height:k})};return}const p=Array.isArray(t)?t:[t],K=p.map(n=>o.measureText(n).width),X=Math.max(...K),O=Number(C)*l;o.textAlign=B,o.textBaseline=L,o.fillStyle=W,o.font=I(`${O}px`),X>c&&(o.font=I(`${O/2}px`));const Z=O+5;let b=(R-(C*p.length+(p.length-1)*5))/2;b=b<0?0:b;for(let n=0;n<p.length;n++)o.fillText(p[n]||"",w/2,b+Z*n);A({url:o.canvas.toDataURL(),width:y,height:k})}function I(w){return`${P} ${E} ${F} ${w} ${z}`}return j()})}var M=tt(),ht=class{constructor(r={}){a(this,"options"),a(this,"container"),a(this,"watermarkContent"),a(this,"watermarkDom"),a(this,"style"),a(this,"watermarkTag"),a(this,"shadowRoot"),a(this,"mutationObserver"),a(this,"_isAgainRender",t=>!!(t.type==="attributes"&&(t.attributeName===d||this.watermarkTag===this._getNodeRandomId(t.target))||t.removedNodes.length&&this.watermarkTag===this._getNodeRandomId(t.removedNodes[0]))),a(this,"_getNodeRandomId",t=>{var e;return(e=t==null?void 0:t.dataset)==null?void 0:e[et(d)]}),a(this,"_destroyMutationObserver",()=>{this.mutationObserver&&(this.mutationObserver.takeRecords(),this.mutationObserver.disconnect(),this.mutationObserver=null)}),a(this,"_getWatermarkDom",t=>S(this,null,function*(){this.watermarkDom||(this.watermarkDom=document.createElement("div")),typeof t=="number"&&t&&(this.style.height=`${t}px`);const e=yield nt(this.options);if(e!=null&&e.url){const i=e.url;this.options.mode==="repeat"?this.style.backgroundImage=`url(${i})`:(this.style.backgroundImage=`url(${i}), url(${i})`,this.style.backgroundRepeat="repeat, repeat",this.style.backgroundPosition=`${e.width/2}px ${e.height/2}px, 0 0`),this.options.container||(this.style.position="fixed",this.style.height=void 0),this.watermarkDom.setAttribute("style",g(this.style))}return this.watermarkDom.setAttribute(d,this.watermarkTag),this.watermarkDom})),a(this,"_getWatermarkHeight",()=>{if(!this.container)return 0;let t=0;const{scrollHeight:e=0,clientHeight:i=0}=this.options.container?this.container.parentNode:this.container;return e>i&&(t=Math.max(e,i)),t}),this.options=Object.assign({},Q,r),this.style={position:"absolute",left:0,top:0,right:0,bottom:0,pointerEvents:"none",overflow:"hidden",backgroundColor:"transparent",backgroundRepeat:"repeat"},this.style.zIndex=this.options.zIndex,this.watermarkTag=it("watermark"),this.mutationObserver=null,this._render()}update(r={}){this.options=x(x({},this.options),r),this.style.zIndex=this.options.zIndex,this._render()}show(){this.watermarkDom&&(this.style.display="block",this.watermarkDom.setAttribute("style",g(this.style)))}hide(){this.watermarkDom&&(this.style.display="none",this.watermarkDom.setAttribute("style",g(this.style)))}destroy(){this.shadowRoot=void 0,this.watermarkContent&&(this.watermarkContent.remove(),this.watermarkContent=void 0),this.watermarkDom&&(this.watermarkDom.remove(),this.watermarkDom=void 0),this._destroyMutationObserver()}_render(){return S(this,null,function*(){this._destroyMutationObserver(),this.container=ot(this.options.container,this.watermarkTag,this.options.containerStyle,this.options.pack),this.watermarkContent||(this.watermarkContent=at(this.watermarkTag),this.container.append(this.watermarkContent));const r=this._getWatermarkHeight();if(this.watermarkDom=yield this._getWatermarkDom(r),this.watermarkContent){const t=this.watermarkContent.childNodes||[];for(let e=0;e<t.length;e++)this.watermarkContent.removeChild(t[e])}typeof this.watermarkContent.attachShadow=="function"?this.shadowRoot||(this.shadowRoot=this.watermarkContent.attachShadow({mode:"open"})):this.shadowRoot=this.watermarkContent,this.shadowRoot.append(this.watermarkDom),M&&this.options.monitor&&(this.mutationObserver=new M(t=>{t.forEach(e=>{if(this._isAgainRender(e)){this.destroy(),this._render();return}})}),this.mutationObserver.observe(this.container,T),this.shadowRoot&&this.mutationObserver.observe(this.shadowRoot,T))})}};export{ht as Watermark,st as blindDecryption,Q as defaultOptions};
